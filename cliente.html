<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de CartÃ£o Fidelidade â€” Cliente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .stamp-circle {
        width: 45px;
        height: 45px;
        border: 3px solid #6366f1;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        cursor: default;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        transition: 0.2s;
        box-shadow: 0 4px 8px rgba(99, 102, 241, 0.2);
      }
      .stamp-circle.stamped {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-color: #047857;
        color: #fff;
        box-shadow: 0 6px 12px rgba(16, 185, 129, 0.4);
      }
      .cartela {
        background: linear-gradient(135deg, #fff 0%, #f8fafc 50%, #e2e8f0 100%);
        border: 3px solid #3b82f6;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(59, 130, 246, 0.15),
          0 5px 15px rgba(0, 0, 0, 0.08);
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen"
  >
    <!-- Header -->
    <header
      class="bg-gradient-to-r from-purple-600 via-blue-600 to-indigo-700 text-white p-6 shadow-2xl"
    >
      <div class="container mx-auto flex justify-between items-center">
        <h1
          class="text-3xl font-bold bg-gradient-to-r from-yellow-300 to-orange-300 bg-clip-text text-transparent"
        >
          ğŸ’³ Sistema de CartÃ£o Fidelidade âœ¨
        </h1>
        <a
          href="index.html"
          class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg"
          >ğŸ  InÃ­cio</a
        >
      </div>
    </header>

    <!-- Login Cliente (local) -->
    <div
      id="userLoginModal"
      class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
    >
      <div class="bg-white p-8 rounded-xl shadow-2xl w-96">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">
          ğŸ‘¤ Login Cliente
        </h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >UsuÃ¡rio</label
            >
            <input
              id="userLoginUser"
              class="w-full p-3 border border-gray-300 rounded-lg"
              placeholder="cliente"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Senha</label
            >
            <input
              id="userLoginPass"
              type="password"
              class="w-full p-3 border border-gray-300 rounded-lg"
              placeholder="123456"
            />
          </div>
          <div class="flex gap-3">
            <button
              id="userLoginBtn2"
              class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium"
            >
              Entrar
            </button>
            <a
              href="index.html"
              class="flex-1 text-center bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg font-medium"
              >Cancelar</a
            >
          </div>
          <p class="mt-3 text-xs text-gray-500 text-center">
            Demo: cliente / 123456
          </p>
        </div>
      </div>
    </div>

    <!-- VIEW -->
    <div id="viewMode" class="container mx-auto p-6 hidden">
      <!-- Destaque -->
      <div
        class="bg-gradient-to-r from-orange-500 via-red-500 to-pink-500 rounded-2xl p-8 mb-8 text-white shadow-2xl"
      >
        <div class="text-center">
          <div class="text-5xl mb-4">ğŸ”ğŸ‰</div>
          <h2 class="text-4xl font-bold mb-4 animate-pulse">
            PRÃŠMIO ESPECIAL!
          </h2>
          <div class="bg-white bg-opacity-20 rounded-xl p-6 backdrop-blur-sm">
            <p class="text-2xl font-semibold mb-2">
              Complete seu CartÃ£o Fidelidade
            </p>
            <p class="text-xl mb-4">
              Colete
              <span
                class="bg-yellow-400 text-black px-3 py-1 rounded-full font-bold"
                >10 PONTOS</span
              >
              e ganhe:
            </p>

            <!-- TÃTULO DO PRÃŠMIO (DINÃ‚MICO) -->
            <div
              class="bg-gradient-to-r from-yellow-400 to-orange-400 text-black px-8 py-4 rounded-2xl text-3xl font-black shadow-lg"
            >
              <span id="prizeTextClient">ğŸ’° R$ 50 VOUCHER IFOOD ğŸ’°</span>
            </div>
            <!-- VALIDADE (DINÃ‚MICA) -->
            <p id="validTextClient" class="text-lg mt-4 opacity-90 hidden">
              ğŸš€ VÃ¡lido em qualquer restaurante do iFood!
            </p>
          </div>
        </div>
      </div>

      <!-- Aviso de rodada travada -->
      <div
        id="lockBanner"
        class="hidden mb-6 p-4 rounded-xl border-2 border-amber-300 bg-amber-50 text-amber-800 text-center font-medium"
      >
        â³ Ganhador pendente â€” nova rodada em breve.
      </div>

      <!-- Regras -->
      <div
        class="bg-gradient-to-r from-red-100 via-orange-100 to-yellow-100 border-2 border-orange-400 rounded-2xl p-6 mb-8 shadow-lg"
      >
        <div class="text-center">
          <h3 class="text-2xl font-bold text-orange-800 mb-4">
            âš  REGRAS IMPORTANTES âš 
          </h3>
          <div class="bg-white bg-opacity-70 rounded-xl p-4 backdrop-blur-sm">
            <div class="text-lg font-semibold text-red-700 mb-2">
              ğŸ”¢ Cada cÃ³digo vale apenas
              <span class="bg-red-200 px-2 py-1 rounded font-bold"
                >1 PONTO</span
              >
            </div>
            <div class="text-lg font-semibold text-orange-700">
              ğŸ† Quem completar
              <span class="bg-yellow-300 px-2 py-1 rounded font-bold"
                >10 PONTOS</span
              >
              primeiro,
            </div>
            <div class="text-lg font-bold text-red-800 mt-2">
              ğŸ”„
              <span class="bg-red-300 px-3 py-1 rounded"
                >ZERARÃ TODOS OS CARTÃ•ES</span
              >
            </div>
            <div class="text-base text-gray-700 mt-3">
              âœ¨ Uma nova rodada comeÃ§arÃ¡ automaticamente apÃ³s a entrega do
              prÃªmio.
            </div>
          </div>
        </div>
      </div>

      <!-- Busca -->
      <div
        class="bg-white rounded-2xl p-6 mb-8 shadow-lg border-2 border-blue-200"
      >
        <h3 class="text-2xl font-bold text-center mb-4 text-gray-800">
          ğŸ” Buscar CartÃ£o
        </h3>
        <div class="flex flex-col md:flex-row gap-4">
          <div class="flex-1">
            <input
              id="searchInput"
              placeholder="Digite o nome ou telefone do cliente..."
              class="w-full p-4 border-2 border-blue-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg"
              oninput="window.filterCartelas()"
            />
          </div>
          <button
            onclick="window.clearSearch()"
            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-4 rounded-xl font-semibold"
          >
            ğŸ—‘ Limpar
          </button>
        </div>
        <div
          id="searchResults"
          class="mt-4 text-center text-gray-600 hidden"
        ></div>
      </div>

      <h2 class="text-3xl font-bold text-center mb-8 text-gray-800">
        ğŸ’³ CartÃµes Fidelidade
      </h2>
      <div
        id="cartelasGrid"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
      ></div>
    </div>

    <!-- Firebase / App -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        doc,
        getDoc,
        onSnapshot,
        serverTimestamp,
        query,
        where,
        limit,
        runTransaction,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyB7UcJxEJHffsvCI_Y9Uylwy943RxBSIEA",
        authDomain: "banco-e3302.firebaseapp.com",
        projectId: "banco-e3302",
        storageBucket: "banco-e3302.firebasestorage.app",
        messagingSenderId: "669890747472",
        appId: "1:669890747472:web:b3188add68fffb010f0555",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      /* ===== Estado ===== */
      let allCartelas = [];
      let roundLocked = false;

      /* ===== Login local ===== */
      const userLoginModal = document.getElementById("userLoginModal");
      const viewMode = document.getElementById("viewMode");
      document.getElementById("userLoginBtn2").addEventListener("click", () => {
        const u = document.getElementById("userLoginUser").value.trim();
        const p = document.getElementById("userLoginPass").value.trim();
        if (u === "cliente" && p === "123456") {
          userLoginModal.classList.add("hidden");
          viewMode.classList.remove("hidden");
        } else alert("âŒ Credenciais invÃ¡lidas. Use: cliente / 123456");
      });

      /* ===== PRÃŠMIO (tempo real) ===== */
      const prizeTextClient = document.getElementById("prizeTextClient");
      const validTextClient = document.getElementById("validTextClient");
      onSnapshot(doc(db, "settings", "premioAtual"), (snap) => {
        if (!snap.exists()) return;
        const { premio, validade } = snap.data() || {};
        if (premio) prizeTextClient.textContent = premio;
        if (validade) {
          validTextClient.textContent = `ğŸš€ ${validade}`;
          validTextClient.classList.remove("hidden");
        } else {
          validTextClient.classList.add("hidden");
        }
      });

      /* ===== Refs / Utils ===== */
      const cartelasGrid = document.getElementById("cartelasGrid");
      const cartelasColRef = collection(db, "cartelas");
      const codesColRef = collection(db, "codes");
      const winnersColRef = collection(db, "winners");
      const lockBanner = document.getElementById("lockBanner");

      const hidePhone = (p = "") =>
        (p || "").replace(/(\d{2})(\d{4,5})(\d{4})/, "($1) $2-****");
      const pw = (stamped, stamps) =>
        Math.round(((stamped?.length || 0) / stamps) * 100);
      const fmtDate = (ts) =>
        ts?.toDate
          ? ts.toDate().toLocaleString("pt-BR")
          : ts instanceof Date
          ? ts.toLocaleString("pt-BR")
          : "";
      function nextEmptyStamp(stamped = [], stamps = 10) {
        const set = new Set(stamped);
        for (let i = 1; i <= stamps; i++) if (!set.has(i)) return i;
        return null;
      }

      /* ===== Render ===== */
      function createCartelaHTML(c) {
        const progress = pw(c.stamped, c.stamps);
        const waitingDelivery = !!(c.winner && c.winner.delivered === false);
        const stamps = [];
        for (let i = 1; i <= c.stamps; i++) {
          const stamped = (c.stamped || []).includes(i);
          stamps.push(
            `<div class="stamp-circle ${stamped ? "stamped" : ""}">${
              stamped ? "âœ“" : i
            }</div>`
          );
        }
        const inputDisabled =
          roundLocked || !c.active || (c.stamped?.length || 0) >= c.stamps;

        return `
          <div class="cartela p-6 ${
            !c.active ? "opacity-60 border-red-300" : ""
          }">
            <div class="text-center mb-4">
              <div class="text-xl font-bold text-gray-800">ğŸ‘¤ ${c.name}</div>
              <div class="text-blue-600 font-semibold">ğŸ“ ${hidePhone(
                c.phone
              )}</div>
              <div class="text-sm text-gray-600 mt-1">Pontos: ${
                (c.stamped || []).length
              }/${c.stamps} (${progress}%)</div>
              <div class="w-full bg-gray-200 rounded-full h-2 mt-2"><div class="bg-green-500 h-2 rounded-full" style="width:${progress}%"></div></div>
            </div>

            <div class="grid grid-cols-5 gap-3 justify-items-center mb-4">${stamps.join(
              ""
            )}</div>

            ${
              waitingDelivery
                ? `
              <div class="p-3 rounded bg-emerald-50 border border-emerald-200 text-center">
                ğŸ‰ <b>CARTÃƒO GANHADOR!</b> Ganhou em: ${fmtDate(
                  c.winner.at
                )}<br/>
                <span class="text-emerald-700 text-sm block mt-1">Aguardando entrega do prÃªmio.</span>
                <span class="text-red-700 text-sm font-medium block mt-2">
                  ğŸ“ Entre em contato com o administrador para retirar seu prÃªmio.
                </span>
              </div>`
                : ""
            }

            ${
              !inputDisabled
                ? `
              <div class="p-3 bg-blue-50 border border-blue-200 rounded">
                <div class="text-blue-700 font-medium text-center mb-2">Insira seu cÃ³digo (vale 1 ponto)</div>
                <div class="flex gap-2">
                  <input id="code-${c.id}" placeholder="CÃ³digo" class="flex-1 p-2 border rounded focus:ring-2 focus:ring-blue-500">
                  <button onclick="window.submitCode('${c.id}')" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white">Validar</button>
                </div>
              </div>`
                : `
              <div class="p-3 bg-gray-50 border border-gray-200 rounded text-center text-gray-600 text-sm">
                ${
                  roundLocked
                    ? "â³ Ganhador pendente â€” nova rodada em breve."
                    : !c.active
                    ? "CartÃ£o inativo."
                    : "CartÃ£o completo!"
                }
              </div>`
            }
          </div>`;
      }

      function renderCartelas(list) {
        const term = (document.getElementById("searchInput")?.value || "")
          .toLowerCase()
          .trim();
        const active = list.filter((c) => c.active);
        const src = term
          ? active.filter(
              (c) =>
                c.name.toLowerCase().includes(term) || c.phone.includes(term)
            )
          : active;
        cartelasGrid.innerHTML = src.map(createCartelaHTML).join("");
        const sr = document.getElementById("searchResults");
        if (!term) sr.classList.add("hidden");
        else {
          sr.classList.remove("hidden");
          sr.textContent = src.length
            ? `${src.length} cartÃ£o(Ãµes) encontrados`
            : `Nenhum cartÃ£o para "${term}"`;
        }
      }

      /* ===== Snapshots ===== */
      onSnapshot(cartelasColRef, (snap) => {
        allCartelas = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
        renderCartelas(allCartelas);
      });
      onSnapshot(
        query(winnersColRef, where("delivered", "==", false), limit(1)),
        (snap) => {
          roundLocked = !snap.empty;
          document
            .getElementById("lockBanner")
            .classList.toggle("hidden", !roundLocked);
          renderCartelas(allCartelas);
        }
      );

      /* ===== Validar cÃ³digo (TRANSACIONAL) ===== */
      async function submitCode(cartelaId) {
        if (roundLocked)
          return alert("â³ HÃ¡ um ganhador pendente. Aguarde a prÃ³xima rodada.");
        const input = document.getElementById(`code-${cartelaId}`);
        const code = (input?.value || "").trim().toUpperCase();
        if (!code) return alert("âŒ Digite um cÃ³digo.");

        try {
          let completedNow = false,
            customerName = "";
          await runTransaction(db, async (tx) => {
            const cartRef = doc(db, "cartelas", cartelaId);
            const cartSnap = await tx.get(cartRef);
            if (!cartSnap.exists()) throw new Error("cartela_nao_encontrada");
            const cart = cartSnap.data();
            customerName = cart.name;
            if (!cart.active) throw new Error("cartela_inativa");
            const current = cart.stamped || [];
            if (current.length >= cart.stamps)
              throw new Error("cartela_completa");

            const codeRef = doc(db, "codes", code);
            const codeSnap = await tx.get(codeRef);
            if (!codeSnap.exists() || !codeSnap.data().active)
              throw new Error("codigo_invalido");

            const usedRef = doc(db, "cartelas", cartelaId, "usedCodes", code);
            const usedSnap = await tx.get(usedRef);
            if (usedSnap.exists())
              throw new Error("codigo_ja_usado_neste_cartao");

            const next = (() => {
              const set = new Set(current);
              for (let i = 1; i <= cart.stamps; i++) if (!set.has(i)) return i;
              return null;
            })();
            if (!next) throw new Error("sem_espaco");

            const newStamped = [...current, next].sort((a, b) => a - b);
            tx.update(cartRef, { stamped: newStamped });
            tx.set(usedRef, { usedAt: serverTimestamp() });

            if (newStamped.length === cart.stamps && !cart.winner) {
              completedNow = true;
              const wRef = doc(collection(db, "winners"));
              tx.set(wRef, {
                name: cart.name,
                phone: cart.phone,
                cartelaId,
                createdAt: serverTimestamp(),
                delivered: false,
              });
              tx.update(cartRef, {
                winner: {
                  at: serverTimestamp(),
                  delivered: false,
                  winnerDocId: wRef.id,
                },
              });
            }
          });

          input.value = "";
          alert(
            completedNow
              ? `ğŸ‰ PARABÃ‰NS ${customerName}! CartÃ£o completo. Aguarde a entrega do prÃªmio.`
              : "âœ… CÃ³digo vÃ¡lido! 1 ponto adicionado."
          );
        } catch (err) {
          console.error(err);
          const map = {
            cartela_inativa: "Este cartÃ£o estÃ¡ inativo.",
            cartela_completa: "CartÃ£o jÃ¡ estÃ¡ completo.",
            codigo_invalido: "CÃ³digo invÃ¡lido ou inativo.",
            codigo_ja_usado_neste_cartao:
              "Este cÃ³digo jÃ¡ foi usado neste cartÃ£o.",
            sem_espaco: "NÃ£o hÃ¡ pontos disponÃ­veis.",
            cartela_nao_encontrada: "Cartela nÃ£o encontrada.",
            "permission-denied":
              "Regras do Firestore bloquearam. Publique as regras fornecidas.",
          };
          alert(
            `âŒ ${map[err.message] || map[err.code] || err.code || err.message}`
          );
        }
      }

      /* ===== Busca ===== */
      function filterCartelas() {
        renderCartelas(allCartelas);
      }
      function clearSearch() {
        document.getElementById("searchInput").value = "";
        document.getElementById("searchResults").classList.add("hidden");
        renderCartelas(allCartelas);
      }

      // expose
      window.submitCode = submitCode;
      window.filterCartelas = filterCartelas;
      window.clearSearch = clearSearch;
    </script>
  </body>
</html>
