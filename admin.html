<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Cartão Fidelidade — Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .stamp-circle {
        width: 45px;
        height: 45px;
        border: 3px solid #6366f1;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: 0.3s;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        box-shadow: 0 4px 8px rgba(99, 102, 241, 0.2);
      }
      .stamp-circle.stamped {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-color: #047857;
        color: #fff;
        box-shadow: 0 6px 12px rgba(16, 185, 129, 0.4);
      }
      .stamp-circle:hover {
        transform: scale(1.12);
        box-shadow: 0 8px 16px rgba(99, 102, 241, 0.3);
      }
      .cartela {
        background: linear-gradient(135deg, #fff 0%, #f8fafc 50%, #e2e8f0 100%);
        border: 3px solid #3b82f6;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(59, 130, 246, 0.15),
          0 5px 15px rgba(0, 0, 0, 0.08);
        transition: 0.3s;
      }
      .cartela:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px rgba(59, 130, 246, 0.2),
          0 10px 20px rgba(0, 0, 0, 0.1);
      }
      .admin-panel {
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen"
  >
    <!-- Header -->
    <header
      class="bg-gradient-to-r from-purple-600 via-blue-600 to-indigo-700 text-white p-6 shadow-2xl"
    >
      <div class="container mx-auto flex justify-between items-center">
        <h1
          class="text-3xl font-bold bg-gradient-to-r from-yellow-300 to-orange-300 bg-clip-text text-transparent"
        >
          💳 Sistema de Cartão Fidelidade ✨ — Admin
        </h1>
        <div class="flex gap-3 items-center">
          <span
            id="adminBadge"
            class="hidden text-sm bg-white/10 px-3 py-1 rounded-full"
          ></span>
          <button
            id="winnersBtn"
            class="hidden bg-gradient-to-r from-amber-500 to-yellow-600 hover:from-amber-600 hover:to-yellow-700 px-4 py-2 rounded-lg font-semibold shadow"
          >
            👑 Ganhadores
          </button>
          <button
            id="logoutBtn"
            class="hidden bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 px-4 py-2 rounded-lg font-semibold shadow"
          >
            🚪 Sair
          </button>
        </div>
      </div>
    </header>

    <!-- Modal Login Admin -->
    <div
      id="adminLoginModal"
      class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
    >
      <div class="bg-white p-8 rounded-xl shadow-2xl w-96">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">
          🔐 Login Administrador
        </h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >E-mail:</label
            >
            <input
              id="adminEmail"
              type="email"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="admin@exemplo.com"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Senha:</label
            >
            <input
              id="adminPass"
              type="password"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="••••••"
            />
          </div>
          <button
            id="adminLoginBtn"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium"
          >
            Entrar
          </button>
          <p class="text-xs text-gray-500">
            Ative <em>Email/Password</em> no Firebase e crie o usuário admin.
          </p>
        </div>
      </div>
    </div>

    <!-- Modal Ganhadores (central) -->
    <div
      id="winnersModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[60]"
    >
      <div class="bg-white w-[min(900px,92vw)] rounded-xl shadow-2xl">
        <div class="px-6 py-4 border-b flex items-center justify-between">
          <h3 class="text-xl font-semibold">👑 Ganhadores</h3>
          <button
            id="closeWinners"
            class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200"
          >
            Fechar
          </button>
        </div>
        <div class="p-6 overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-50">
              <tr class="text-left">
                <th class="px-3 py-2">Nome</th>
                <th class="px-3 py-2">Telefone</th>
                <th class="px-3 py-2">Data/Hora</th>
                <th class="px-3 py-2">Status</th>
                <th class="px-3 py-2">Ação</th>
              </tr>
            </thead>
            <tbody id="winnersTable">
              <tr id="winnersLoading">
                <td colspan="5" class="px-3 py-6 text-center text-gray-500">
                  Carregando…
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Painel -->
    <main id="adminMode" class="hidden">
      <div class="admin-panel text-white p-6">
        <div class="container mx-auto">
          <h2 class="text-3xl font-bold mb-6">⚙ Painel Administrativo</h2>

          <!-- Novo Cartão -->
          <div class="bg-white text-gray-800 p-6 rounded-xl mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold">➕ Novo Cartão Fidelidade</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
              <input
                id="newName"
                type="text"
                placeholder="Nome do cliente"
                class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              />
              <input
                id="newPhone"
                type="text"
                placeholder="Telefone (ex: 21988887777)"
                class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              />
              <input
                id="newStamps"
                type="number"
                value="10"
                min="10"
                max="10"
                readonly
                class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              />
              <button
                id="addCartelaBtn"
                class="bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-medium"
              >
                ➕ Criar
              </button>
              <button
                id="blockAllCardsBtn"
                class="bg-orange-600 hover:bg-orange-700 text-white py-3 px-6 rounded-lg font-medium"
              >
                🔒 Bloquear Todos
              </button>
              <button
                id="deleteAllCardsBtn"
                class="bg-red-600 hover:bg-red-700 text-white py-3 px-6 rounded-lg font-medium"
              >
                🗑 Excluir Todos
              </button>
            </div>
          </div>

          <!-- Gerenciar Códigos -->
          <div class="bg-white text-gray-800 p-6 rounded-xl mb-6">
            <h3 class="text-xl font-bold mb-4">🔑 Gerenciar Códigos</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <input
                id="newCode"
                type="text"
                placeholder="Novo código (ex: ABC123)"
                class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              />
              <input
                id="codePoints"
                type="number"
                value="1"
                min="1"
                max="1"
                readonly
                class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              />
              <button
                id="addCodeBtn"
                class="bg-purple-600 hover:bg-purple-700 text-white py-3 px-6 rounded-lg font-medium"
              >
                Criar Código
              </button>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <h4 class="font-semibold mb-2">📝 Códigos Ativos</h4>
              <div id="activeCodesList" class="space-y-2"></div>
            </div>
          </div>

          <!-- Gerenciar Cartões -->
          <div class="bg-white text-gray-800 p-6 rounded-xl">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-bold">📋 Gerenciar Cartões</h3>
              <button
                id="openWinnersTop"
                class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg font-semibold"
              >
                👑 Ganhadores
              </button>
            </div>
            <div id="adminCartelasGrid" class="mt-4 space-y-4"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- Firebase / App -->
    <script type="module">
      /* Firebase SDK */
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        signOut,
        setPersistence,
        browserLocalPersistence,
      } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        doc,
        addDoc,
        setDoc,
        getDoc,
        getDocs,
        updateDoc,
        deleteDoc,
        onSnapshot,
        writeBatch,
        serverTimestamp,
        query,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyB7UcJxEJHffsvCI_Y9Uylwy943RxBSIEA",
        authDomain: "banco-e3302.firebaseapp.com",
        projectId: "banco-e3302",
        storageBucket: "banco-e3302.firebasestorage.app",
        messagingSenderId: "669890747472",
        appId: "1:669890747472:web:b3188add68fffb010f0555",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      await setPersistence(auth, browserLocalPersistence);

      /* State / Refs */
      const adminLoginModal = document.getElementById("adminLoginModal");
      const adminMode = document.getElementById("adminMode");
      const adminBadge = document.getElementById("adminBadge");
      const logoutBtn = document.getElementById("logoutBtn");
      const winnersBtn = document.getElementById("winnersBtn");
      const openWinnersTop = document.getElementById("openWinnersTop");

      const adminEmail = document.getElementById("adminEmail");
      const adminPass = document.getElementById("adminPass");
      const adminLoginBtn = document.getElementById("adminLoginBtn");

      const adminCartelasGrid = document.getElementById("adminCartelasGrid");
      const activeCodesList = document.getElementById("activeCodesList");

      const winnersModal = document.getElementById("winnersModal");
      const closeWinners = document.getElementById("closeWinners");
      const winnersTable = document.getElementById("winnersTable");
      const winnersLoading = document.getElementById("winnersLoading");

      const cartelasColRef = collection(db, "cartelas");
      const codesColRef = collection(db, "codes");
      const winnersColRef = collection(db, "winners");

      let allCartelas = [];
      let allCodes = [];
      let allWinners = [];

      /* Auth */
      function showLogin() {
        adminLoginModal.classList.remove("hidden");
      }
      function hideLogin() {
        adminLoginModal.classList.add("hidden");
      }
      function showPanel() {
        adminMode.classList.remove("hidden");
        logoutBtn.classList.remove("hidden");
        winnersBtn.classList.remove("hidden");
      }
      function hidePanel() {
        adminMode.classList.add("hidden");
        logoutBtn.classList.add("hidden");
        winnersBtn.classList.add("hidden");
      }

      async function handleAdminLogin() {
        const email = adminEmail.value.trim();
        const pass = adminPass.value.trim();
        if (!email || !pass) return alert("Preencha e-mail e senha.");
        try {
          await signInWithEmailAndPassword(auth, email, pass);
        } catch (e) {
          console.error(e);
          alert("❌ Não foi possível entrar. Verifique as credenciais.");
        }
      }
      async function handleLogout() {
        try {
          await signOut(auth);
        } catch (e) {}
        hidePanel();
        adminBadge.classList.add("hidden");
        adminBadge.textContent = "";
        window.location.href = "index.html"; // voltar ao início
      }

      onAuthStateChanged(auth, (user) => {
        if (user) {
          hideLogin();
          showPanel();
          adminBadge.classList.remove("hidden");
          adminBadge.textContent = `Admin: ${user.email}`;
        } else {
          hidePanel();
          showLogin();
        }
      });
      adminLoginBtn.addEventListener("click", handleAdminLogin);
      adminPass.addEventListener("keydown", (e) => {
        if (e.key === "Enter") handleAdminLogin();
      });
      logoutBtn.addEventListener("click", handleLogout);

      /* Utils */
      const formatPhone = (p) =>
        p.replace(/(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
      const progressWidth = (stamped, stamps) =>
        Math.round((stamped.length / stamps) * 100);
      const hasOpenWinner = (c) => c.winner && c.winner.delivered === false;

      /* Render Cartelas */
      function createCartelaHTML(cartela) {
        const stampsButtons = [];
        for (let i = 1; i <= cartela.stamps; i++) {
          const stamped = (cartela.stamped || []).includes(i);
          stampsButtons.push(`
            <div class="stamp-circle ${
              stamped ? "stamped" : ""
            }" onclick="window.toggleStamp('${cartela.id}',${i})">${
            stamped ? "✓" : i
          }</div>
          `);
        }
        const progress = progressWidth(cartela.stamped || [], cartela.stamps);
        const winnerBlock = hasOpenWinner(cartela)
          ? `
          <div class="mt-4 p-4 bg-emerald-50 border-2 border-amber-300 rounded-lg text-center">
            <div class="text-green-800 font-bold text-lg">🎉 CARTÃO GANHADOR! 🎉</div>
            <div class="text-amber-700 text-sm mt-1">
              Ganhou em:
              <span class="font-semibold">
                ${
                  cartela.winner.at?.toDate
                    ? cartela.winner.at.toDate().toLocaleString("pt-BR")
                    : "—"
                }
              </span>
            </div>
            <div class="text-gray-700 text-sm mt-1">Aguardando entrega do prêmio.</div>
          </div>`
          : "";

        return `
        <div class="cartela p-6 ${
          !cartela.active ? "opacity-60 border-red-300" : ""
        }">
          <div class="text-center mb-4">
            <div class="flex items-center justify-center gap-2 mb-1">
              <div class="text-xl font-bold text-gray-800">👤 ${
                cartela.name
              }</div>
              <span class="text-xs px-2 py-1 rounded-full ${
                cartela.active
                  ? "bg-green-100 text-green-700"
                  : "bg-red-100 text-red-700"
              }">${cartela.active ? "Ativo" : "Inativo"}</span>
            </div>
            <div class="text-lg font-semibold text-blue-600 mb-2">📞 ${formatPhone(
              cartela.phone
            )}</div>
            <div class="text-sm text-gray-600">Pontos: ${
              (cartela.stamped || []).length
            }/${cartela.stamps} (${progress}%)</div>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
              <div class="bg-green-500 h-2 rounded-full" style="width:${progress}%"></div>
            </div>
          </div>

          <div class="grid grid-cols-5 gap-3 justify-items-center">${stampsButtons.join(
            ""
          )}</div>

          ${winnerBlock}

          <div class="mt-4 grid grid-cols-4 gap-2">
            <button onclick="window.toggleUserStatus('${
              cartela.id
            }')" class="bg-${
          cartela.active ? "orange" : "green"
        }-500 hover:bg-${
          cartela.active ? "orange" : "green"
        }-600 text-white py-2 px-3 rounded-lg text-sm">${
          cartela.active ? "⏸ Desativar" : "▶ Ativar"
        }</button>
            <button onclick="window.resetCartela('${
              cartela.id
            }')"  class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-3 rounded-lg text-sm">🔄 Resetar</button>
            <button onclick="window.editCartela('${
              cartela.id
            }')"   class="bg-blue-500   hover:bg-blue-600   text-white py-2 px-3 rounded-lg text-sm">✏ Editar</button>
            <button onclick="window.deleteCartela('${
              cartela.id
            }')" class="bg-red-500    hover:bg-red-600    text-white py-2 px-3 rounded-lg text-sm">🗑 Excluir</button>
          </div>
        </div>`;
      }
      function renderAdminCartelas(cartelas) {
        adminCartelasGrid.innerHTML = cartelas
          .map((c) => createCartelaHTML(c))
          .join("");
      }

      /* Codes UI */
      function renderActiveCodes(codes) {
        if (!codes.length) {
          activeCodesList.innerHTML =
            '<p class="text-gray-500 text-sm">Nenhum código cadastrado</p>';
          return;
        }
        activeCodesList.innerHTML = codes
          .map(
            (code) => `
          <div class="flex items-center justify-between p-3 bg-white rounded-lg border ${
            code.active ? "border-green-200" : "border-red-200"
          }">
            <div class="flex items-center gap-3">
              <span class="font-mono font-bold text-lg ${
                code.active ? "text-green-700" : "text-red-500"
              }">${code.id}</span>
              <span class="text-sm text-gray-600">1 ponto</span>
              <span class="text-xs px-2 py-1 rounded-full ${
                code.active
                  ? "bg-green-100 text-green-700"
                  : "bg-red-100 text-red-700"
              }">${code.active ? "Ativo" : "Inativo"}</span>
            </div>
            <div class="flex gap-2">
              <button onclick="window.toggleCodeStatus('${
                code.id
              }')" class="text-xs px-3 py-1 rounded ${
              code.active
                ? "bg-yellow-500 hover:bg-yellow-600"
                : "bg-green-500 hover:bg-green-600"
            } text-white">${code.active ? "Desativar" : "Ativar"}</button>
              <button onclick="window.editCode('${
                code.id
              }')"  class="text-xs px-3 py-1 rounded bg-blue-500 hover:bg-blue-600 text-white">Editar</button>
              <button onclick="window.deleteCode('${
                code.id
              }')" class="text-xs px-3 py-1 rounded bg-red-500 hover:bg-red-600 text-white">Excluir</button>
            </div>
          </div>`
          )
          .join("");
      }

      /* Winners modal */
      const openWinners = () => {
        winnersModal.classList.remove("hidden");
        winnersModal.classList.add("flex");
      };
      const closeWinnersM = () => {
        winnersModal.classList.add("hidden");
        winnersModal.classList.remove("flex");
      };
      winnersBtn.addEventListener("click", openWinners);
      openWinnersTop.addEventListener("click", openWinners);
      closeWinners.addEventListener("click", closeWinnersM);
      winnersModal.addEventListener("click", (e) => {
        if (e.target === winnersModal) closeWinnersM();
      });

      function renderWinners() {
        winnersLoading?.remove();
        if (!allWinners.length) {
          winnersTable.innerHTML = `<tr><td colspan="5" class="px-3 py-6 text-center text-gray-500">Sem ganhadores ainda</td></tr>`;
          return;
        }
        winnersTable.innerHTML = allWinners
          .map(
            (w) => `
          <tr class="border-b last:border-0">
            <td class="px-3 py-2">${w.name}</td>
            <td class="px-3 py-2">${formatPhone(w.phone)}</td>
            <td class="px-3 py-2">${
              w.createdAt?.toDate
                ? w.createdAt.toDate().toLocaleString("pt-BR")
                : "—"
            }</td>
            <td class="px-3 py-2">
              ${
                w.delivered
                  ? '<span class="text-green-700 bg-green-100 px-2 py-1 rounded text-xs">Entregue</span>'
                  : '<span class="text-amber-700 bg-amber-100 px-2 py-1 rounded text-xs">Pendente</span>'
              }
            </td>
            <td class="px-3 py-2">
              ${
                w.delivered
                  ? ""
                  : `<button onclick="window.markDelivered('${w.id}','${w.cartelaId}')" class="px-3 py-1 rounded bg-emerald-600 hover:bg-emerald-700 text-white text-xs">Marcar como Entregue</button>`
              }
            </td>
          </tr>`
          )
          .join("");
      }

      /* Listeners Firestore */
      onSnapshot(cartelasColRef, (snap) => {
        allCartelas = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
        if (!adminMode.classList.contains("hidden"))
          renderAdminCartelas(allCartelas);
      });
      onSnapshot(codesColRef, (snap) => {
        allCodes = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
        if (!adminMode.classList.contains("hidden"))
          renderActiveCodes(allCodes);
      });
      onSnapshot(query(winnersColRef, orderBy("createdAt", "desc")), (snap) => {
        allWinners = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
        renderWinners();
      });

      /* Cartelas: ações */
      document
        .getElementById("addCartelaBtn")
        .addEventListener("click", addNewCartela);
      document
        .getElementById("blockAllCardsBtn")
        .addEventListener("click", blockAllCards);
      document
        .getElementById("deleteAllCardsBtn")
        .addEventListener("click", deleteAllCards);
      document
        .getElementById("addCodeBtn")
        .addEventListener("click", addNewCode);

      async function addNewCartela() {
        const name = document.getElementById("newName").value.trim();
        const phone = document.getElementById("newPhone").value.trim();
        const stamps = parseInt(document.getElementById("newStamps").value, 10);
        if (!name || !phone) return alert("❌ Preencha todos os campos!");
        if (phone.length < 10 || phone.length > 11)
          return alert("❌ Telefone deve ter 10 ou 11 dígitos!");
        await addDoc(cartelasColRef, {
          name,
          phone,
          stamps,
          stamped: [],
          active: true,
          createdAt: serverTimestamp(),
        });
        document.getElementById("newName").value = "";
        document.getElementById("newPhone").value = "";
        alert("✅ Cartão criado!");
      }

      async function toggleStamp(cartelaId, num) {
        const c = allCartelas.find((x) => x.id === cartelaId);
        if (!c) return;
        const newStamped = (c.stamped || []).includes(num)
          ? (c.stamped || []).filter((n) => n !== num)
          : [...(c.stamped || []), num].sort((a, b) => a - b);

        await updateDoc(doc(db, "cartelas", cartelaId), {
          stamped: newStamped,
        });

        // Se completou pelo admin, registra vencedor e reseta rodada
        if (newStamped.length === c.stamps && !hasOpenWinner(c)) {
          await registerWinnerAndReset({ ...c, stamped: newStamped });
        }
      }

      async function resetCartela(cartelaId) {
        if (!confirm("Resetar este cartão?")) return;
        await updateDoc(doc(db, "cartelas", cartelaId), { stamped: [] });
        const usedRef = collection(db, "cartelas", cartelaId, "usedCodes");
        const usedSnap = await getDocs(usedRef);
        const batch = writeBatch(db);
        usedSnap.forEach((d) =>
          batch.delete(doc(db, "cartelas", cartelaId, "usedCodes", d.id))
        );
        await batch.commit();
        alert("✅ Cartão resetado!");
      }

      async function deleteCartela(cartelaId) {
        if (!confirm("Excluir este cartão permanentemente?")) return;
        const usedRef = collection(db, "cartelas", cartelaId, "usedCodes");
        const usedSnap = await getDocs(usedRef);
        const batch = writeBatch(db);
        usedSnap.forEach((d) =>
          batch.delete(doc(db, "cartelas", cartelaId, "usedCodes", d.id))
        );
        batch.delete(doc(db, "cartelas", cartelaId));
        await batch.commit();
        alert("🗑 Cartão excluído!");
      }

      async function toggleUserStatus(cartelaId) {
        const c = allCartelas.find((x) => x.id === cartelaId);
        if (!c) return;
        const action = c.active ? "desativar" : "ativar";
        if (!confirm(`Deseja ${action} o cartão de ${c.name}?`)) return;
        await updateDoc(doc(db, "cartelas", cartelaId), { active: !c.active });
      }

      async function editCartela(cartelaId) {
        const c = allCartelas.find((x) => x.id === cartelaId);
        if (!c) return;
        const newName = prompt(`Editar nome (atual: ${c.name})`, c.name);
        if (newName === null) return;
        const newPhone = prompt(`Editar telefone (atual: ${c.phone})`, c.phone);
        if (newPhone === null) return;
        if (newPhone.length < 10 || newPhone.length > 11)
          return alert("Telefone inválido");
        await updateDoc(doc(db, "cartelas", cartelaId), {
          name: newName.trim(),
          phone: newPhone.trim(),
        });
        alert("✅ Cartão atualizado!");
      }

      async function blockAllCards() {
        if (!confirm("Bloquear todos os cartões?")) return;
        const batch = writeBatch(db);
        allCartelas.forEach((c) =>
          batch.update(doc(db, "cartelas", c.id), { active: false })
        );
        await batch.commit();
        alert("🔒 Todos bloqueados.");
      }

      async function deleteAllCards() {
        if (!confirm("IRREVERSÍVEL! Excluir TODOS os cartões?")) return;
        const k = prompt('Digite "CONFIRMAR" para prosseguir:');
        if (k !== "CONFIRMAR") return alert("Cancelado.");
        for (const c of allCartelas) {
          const usedRef = collection(db, "cartelas", c.id, "usedCodes");
          const usedSnap = await getDocs(usedRef);
          const batch = writeBatch(db);
          usedSnap.forEach((d) =>
            batch.delete(doc(db, "cartelas", c.id, "usedCodes", d.id))
          );
          batch.delete(doc(db, "cartelas", c.id));
          await batch.commit();
        }
        alert("🗑 Todos os cartões excluídos.");
      }

      /* Códigos */
      async function addNewCode() {
        const code = document
          .getElementById("newCode")
          .value.trim()
          .toUpperCase();
        if (!code) return alert("Digite um código");
        const ref = doc(db, "codes", code);
        if ((await getDoc(ref)).exists()) return alert("Código já existe.");
        await setDoc(ref, {
          points: 1,
          active: true,
          createdAt: serverTimestamp(),
        });
        document.getElementById("newCode").value = "";
        alert("✅ Código criado (1 ponto).");
      }
      async function toggleCodeStatus(codeId) {
        const ref = doc(db, "codes", codeId);
        const s = await getDoc(ref);
        if (!s.exists()) return;
        await updateDoc(ref, { active: !s.data().active });
      }
      async function editCode(oldCode) {
        const n = prompt(`Editar código "${oldCode}"`, oldCode);
        if (n === null) return;
        const up = n.trim().toUpperCase();
        if (!up || up === oldCode) return;
        const newRef = doc(db, "codes", up);
        if ((await getDoc(newRef)).exists())
          return alert("Já existe um código com esse nome!");
        const oldRef = doc(db, "codes", oldCode);
        const snap = await getDoc(oldRef);
        if (!snap.exists()) return;
        await setDoc(newRef, snap.data());
        await deleteDoc(oldRef);
        alert(`✅ Código alterado para "${up}".`);
      }
      async function deleteCode(codeId) {
        if (!confirm(`Excluir código ${codeId}?`)) return;
        await deleteDoc(doc(db, "codes", codeId));
        alert("✅ Código excluído.");
      }

      /* Winner flow */
      async function registerWinnerAndReset(cartela) {
        // winners
        const wRef = await addDoc(winnersColRef, {
          name: cartela.name,
          phone: cartela.phone,
          cartelaId: cartela.id,
          createdAt: serverTimestamp(),
          delivered: false,
        });
        // flag no cartão vencedor
        await updateDoc(doc(db, "cartelas", cartela.id), {
          winner: {
            at: serverTimestamp(),
            delivered: false,
            winnerDocId: wRef.id,
          },
        });
        // reset geral + limpar usedCodes
        const batchSize = 400;
        for (let i = 0; i < allCartelas.length; i += batchSize) {
          const slice = allCartelas.slice(i, i + batchSize);
          const batch = writeBatch(db);
          slice.forEach((c) =>
            batch.update(doc(db, "cartelas", c.id), { stamped: [] })
          );
          await batch.commit();
        }
        for (const c of allCartelas) {
          const usedRef = collection(db, "cartelas", c.id, "usedCodes");
          const usedSnap = await getDocs(usedRef);
          const batch = writeBatch(db);
          usedSnap.forEach((d) =>
            batch.delete(doc(db, "cartelas", c.id, "usedCodes", d.id))
          );
          await batch.commit();
        }
      }

      async function markDelivered(winnerId, cartelaId) {
        await updateDoc(doc(db, "winners", winnerId), {
          delivered: true,
          deliveredAt: serverTimestamp(),
        });
        const cRef = doc(db, "cartelas", cartelaId);
        const cSnap = await getDoc(cRef);
        if (cSnap.exists()) {
          const w = cSnap.data().winner || {};
          await updateDoc(cRef, {
            winner: { ...w, delivered: true, deliveredAt: serverTimestamp() },
          });
        }
        alert("✅ Entrega confirmada!");
      }

      // expose
      window.toggleStamp = toggleStamp;
      window.resetCartela = resetCartela;
      window.deleteCartela = deleteCartela;
      window.toggleUserStatus = toggleUserStatus;
      window.editCartela = editCartela;
      window.toggleCodeStatus = toggleCodeStatus;
      window.editCode = editCode;
      window.deleteCode = deleteCode;
      window.markDelivered = markDelivered;

      // start
      showLogin();
    </script>
  </body>
</html>
