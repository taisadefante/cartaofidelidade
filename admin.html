<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Cartão Fidelidade — Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .stamp-circle {
        width: 45px;
        height: 45px;
        border: 3px solid #6366f1;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: 0.2s;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        box-shadow: 0 4px 8px rgba(99, 102, 241, 0.2);
      }
      .stamp-circle.stamped {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-color: #047857;
        color: #fff;
        box-shadow: 0 6px 12px rgba(16, 185, 129, 0.4);
      }
      .stamp-circle:hover {
        transform: scale(1.08);
        box-shadow: 0 8px 16px rgba(99, 102, 241, 0.28);
      }
      .cartela {
        background: linear-gradient(135deg, #fff 0%, #f8fafc 50%, #e2e8f0 100%);
        border: 3px solid #3b82f6;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(59, 130, 246, 0.15),
          0 5px 15px rgba(0, 0, 0, 0.08);
        transition: 0.2s;
      }
      .cartela:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px rgba(59, 130, 246, 0.2),
          0 10px 20px rgba(0, 0, 0, 0.1);
      }
      .admin-panel {
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
      }
      .btn {
        border-radius: 0.6rem;
        padding: 0.6rem 1rem;
        font-weight: 600;
      }
      .btn-prim {
        background: #2563eb;
        color: #fff;
      }
      .btn-prim:hover {
        background: #1d4ed8;
      }
      .btn-gray {
        background: #6b7280;
        color: #fff;
      }
      .btn-gray:hover {
        background: #4b5563;
      }
      .btn-red {
        background: #ef4444;
        color: #fff;
      }
      .btn-red:hover {
        background: #dc2626;
      }
      .btn-green {
        background: #16a34a;
        color: #fff;
      }
      .btn-green:hover {
        background: #15803d;
      }
      .btn-amber {
        background: #f59e0b;
        color: #fff;
      }
      .btn-amber:hover {
        background: #d97706;
      }

      /* Responsividade extra para telas muito pequenas */
      @media (max-width: 480px) {
        .stamp-circle {
          width: 38px;
          height: 38px;
          font-size: 12px;
          border-width: 2px;
        }
        .cartela {
          border-width: 2px;
        }
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen"
  >
    <!-- Header -->
    <header
      class="bg-gradient-to-r from-purple-600 via-blue-600 to-indigo-700 text-white py-4 sm:py-6 shadow-2xl"
    >
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"
      >
        <h1
          class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-yellow-300 to-orange-300 bg-clip-text text-transparent"
        >
          💳 Sistema de Cartão Fidelidade ✨ — Admin
        </h1>
        <div class="flex flex-wrap gap-2 sm:gap-3 items-center">
          <span
            id="adminBadge"
            class="hidden text-xs sm:text-sm bg-white/10 px-3 py-1 rounded-full"
          ></span>
          <button id="winnersBtn" class="hidden btn btn-amber text-sm">
            👑 Ganhadores
          </button>
          <button id="logoutBtn" class="hidden btn btn-gray text-sm">
            🚪 Sair
          </button>
        </div>
      </div>
    </header>

    <!-- Modal Login Admin -->
    <div
      id="adminLoginModal"
      class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
    >
      <div
        class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-[min(420px,92vw)]"
      >
        <h2
          class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6 text-center text-gray-800"
        >
          🔐 Login Administrador
        </h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >E-mail</label
            >
            <input
              id="adminEmail"
              type="email"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="admin@exemplo.com"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Senha</label
            >
            <input
              id="adminPass"
              type="password"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="••••••"
            />
          </div>
          <button id="adminLoginBtn" class="w-full btn btn-prim">Entrar</button>
          <p class="text-xs text-gray-500">
            Ative <em>Email/Password</em> no Firebase Auth e crie o usuário
            admin.
          </p>
        </div>
      </div>
    </div>

    <!-- Modal Ganhadores -->
    <div
      id="winnersModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[60]"
    >
      <div class="bg-white w-[min(900px,92vw)] rounded-xl shadow-2xl">
        <div
          class="px-4 sm:px-6 py-3 sm:py-4 border-b flex items-center justify-between"
        >
          <h3 class="text-lg sm:text-xl font-semibold">👑 Ganhadores</h3>
          <button
            id="closeWinners"
            class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200"
          >
            Fechar
          </button>
        </div>
        <div class="p-4 sm:p-6 overflow-x-auto">
          <table class="w-full text-xs sm:text-sm">
            <thead class="bg-gray-50">
              <tr class="text-left">
                <th class="px-3 py-2">Nome</th>
                <th class="px-3 py-2">Telefone</th>
                <th class="px-3 py-2">Data/Hora</th>
                <th class="px-3 py-2">Status</th>
              </tr>
            </thead>
            <tbody id="winnersTable">
              <tr id="winnersLoading">
                <td colspan="5" class="px-3 py-6 text-center text-gray-500">
                  Carregando…
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal Entregar Prêmio -->
    <div
      id="deliverModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[70]"
    >
      <div class="bg-white p-6 rounded-xl shadow-2xl w-[min(420px,92vw)]">
        <h3 class="text-lg font-semibold mb-3">
          🎁 Confirmar Entrega do Prêmio
        </h3>
        <label class="block text-sm text-gray-700 mb-1">Data da entrega</label>
        <input
          id="deliverDate"
          type="datetime-local"
          class="w-full p-2 border rounded-lg mb-4"
        />
        <div class="flex justify-end gap-2">
          <button id="deliverCancel" class="btn btn-gray">Cancelar</button>
          <button id="deliverConfirm" class="btn btn-green">Confirmar</button>
        </div>
      </div>
    </div>

    <!-- Painel -->
    <main id="adminMode" class="hidden">
      <div class="admin-panel text-white py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6">
          <h2 class="text-2xl sm:text-3xl font-bold mb-6">
            ⚙ Painel Administrativo
          </h2>

          <!-- PRÊMIO ATUAL -->
          <div class="bg-white text-gray-800 p-5 sm:p-6 rounded-xl mb-6">
            <div
              class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4"
            >
              <h3 class="text-lg sm:text-xl font-bold">
                🏆 Prêmio Atual (exibido para o cliente)
              </h3>
              <span id="prizeSavedAt" class="text-xs text-gray-500"></span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4">
              <input
                id="premioInput"
                class="p-3 border rounded-lg"
                placeholder="💰 PRÊMIO: R$ 50 VOUCHER IFOOD"
              />
              <input
                id="validadeInput"
                class="p-3 border rounded-lg"
                placeholder="✅ Válido em qualquer restaurante do iFood!"
              />
              <button id="savePrizeBtn" class="btn btn-green w-full md:w-auto">
                💾 Salvar Prêmio
              </button>
            </div>
            <p class="text-sm text-gray-600 mt-3">
              Edite e salve — o cliente recebe em tempo real.
            </p>
          </div>

          <!-- Gerenciar Códigos -->
          <div class="bg-white text-gray-800 p-5 sm:p-6 rounded-xl mb-6">
            <h3 class="text-lg sm:text-xl font-bold mb-4">
              🔑 Gerenciar Códigos
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4 mb-4">
              <input
                id="newCode"
                type="text"
                placeholder="Novo código (ex: ABC123)"
                class="p-3 border rounded-lg uppercase"
              />
              <input
                id="codePoints"
                type="number"
                value="1"
                min="1"
                max="1"
                readonly
                class="p-3 border rounded-lg"
              />
              <button id="addCodeBtn" class="btn btn-prim w-full md:w-auto">
                Criar Código
              </button>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <h4 class="font-semibold mb-2">📝 Códigos Ativos</h4>
              <div id="activeCodesList" class="space-y-2"></div>
            </div>
          </div>

          <!-- Novo Cartão -->
          <div class="bg-white text-gray-800 p-5 sm:p-6 rounded-xl mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg sm:text-xl font-bold">
                ➕ Novo Cartão Fidelidade
              </h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-3 sm:gap-4">
              <input
                id="newName"
                type="text"
                placeholder="Nome do cliente"
                class="p-3 border rounded-lg"
              />
              <input
                id="newPhone"
                type="text"
                placeholder="Telefone (ex: 21988887777)"
                class="p-3 border rounded-lg"
              />
              <input
                id="newStamps"
                type="number"
                value="10"
                min="10"
                max="10"
                readonly
                class="p-3 border rounded-lg"
              />
              <button id="addCartelaBtn" class="btn btn-green w-full md:w-auto">
                ➕ Criar
              </button>
              <button
                id="blockAllCardsBtn"
                class="btn btn-amber w-full md:w-auto"
              >
                🔒 Bloquear Todos
              </button>
              <button
                id="deleteAllCardsBtn"
                class="btn btn-red w-full md:w-auto"
              >
                🗑 Excluir Todos
              </button>
            </div>
          </div>

          <!-- Gerenciar Cartões -->
          <div class="bg-white text-gray-800 p-5 sm:p-6 rounded-xl">
            <div
              class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3"
            >
              <h3 class="text-lg sm:text-xl font-bold">📋 Gerenciar Cartões</h3>
              <div class="flex gap-3 items-center">
                <input
                  id="searchCards"
                  placeholder="Buscar por nome ou telefone…"
                  class="p-2 border rounded-lg w-full sm:w-64"
                />
                <button id="openWinnersTop" class="btn btn-amber">
                  👑 Ganhadores
                </button>
              </div>
            </div>
            <div
              id="adminCartelasGrid"
              class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-4"
            ></div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t mt-10 relative">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-5">
        <!-- Direitos -->
        <div class="text-center text-sm text-gray-600">
          © <span id="yearNow"></span> — Todos os direitos reservados.
        </div>
        <!-- Termos -->
        <div class="text-center mt-1">
          <button
            id="openPrivacy"
            class="text-blue-500 hover:underline text-sm"
          >
            Termo de Privacidade
          </button>
        </div>
      </div>
      <!-- Desenvolvimento canto direito -->
      <div class="text-center text-xs text-gray-400 mt-2">
        desenvolvido em parceria com
        <a
          href="https://defan.com.br"
          target="_blank"
          rel="noopener noreferrer"
          class="hover:text-blue-500 transition-colors"
        >
          Defan Soluções Digitais
        </a>
      </div>
    </footer>

    <!-- Modal Privacidade -->
    <div
      id="privacyModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[80]"
    >
      <div class="bg-white w-[min(720px,94vw)] p-6 rounded-xl shadow-2xl">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">Termo de Privacidade</h3>
          <button
            id="closePrivacy"
            class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200"
          >
            Fechar
          </button>
        </div>
        <div class="text-sm text-gray-700 space-y-3">
          <p>
            Coletamos e usamos apenas os dados necessários para operar o
            programa de fidelidade: nome e telefone do cliente, pontos
            acumulados no cartão, e histórico de ganhadores.
          </p>
          <p>
            Não vendemos nem compartilhamos dados com terceiros. Você pode
            solicitar correção ou exclusão do seu cartão a qualquer momento.
          </p>
          <p>
            Os dados são armazenados com segurança no Firebase (Google Cloud).
          </p>
        </div>
      </div>
    </div>

    <!-- Firebase / App -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        signOut,
        setPersistence,
        browserLocalPersistence,
      } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        doc,
        addDoc,
        setDoc,
        getDoc,
        getDocs,
        updateDoc,
        deleteDoc,
        writeBatch,
        serverTimestamp,
        onSnapshot,
        query,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyB7UcJxEJHffsvCI_Y9Uylwy943RxBSIEA",
        authDomain: "banco-e3302.firebaseapp.com",
        projectId: "banco-e3302",
        storageBucket: "banco-e3302.firebasestorage.app",
        messagingSenderId: "669890747472",
        appId: "1:669890747472:web:b3188add68fffb010f0555",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      await setPersistence(auth, browserLocalPersistence);

      /* --------- Refs / UI --------- */
      const adminLoginModal = document.getElementById("adminLoginModal");
      const adminMode = document.getElementById("adminMode");
      const adminBadge = document.getElementById("adminBadge");
      const logoutBtn = document.getElementById("logoutBtn");
      const winnersBtn = document.getElementById("winnersBtn");
      const openWinnersTop = document.getElementById("openWinnersTop");

      const adminEmail = document.getElementById("adminEmail");
      const adminPass = document.getElementById("adminPass");
      const adminLoginBtn = document.getElementById("adminLoginBtn");

      const adminCartelasGrid = document.getElementById("adminCartelasGrid");
      const activeCodesList = document.getElementById("activeCodesList");
      const searchCards = document.getElementById("searchCards");

      const winnersModal = document.getElementById("winnersModal");
      const closeWinners = document.getElementById("closeWinners");
      const winnersTable = document.getElementById("winnersTable");
      const winnersLoading = document.getElementById("winnersLoading");

      const deliverModal = document.getElementById("deliverModal");
      const deliverDate = document.getElementById("deliverDate");
      const deliverCancel = document.getElementById("deliverCancel");
      const deliverConfirm = document.getElementById("deliverConfirm");

      const privacyModal = document.getElementById("privacyModal");
      const openPrivacy = document.getElementById("openPrivacy");
      const closePrivacy = document.getElementById("closePrivacy");
      const yearNow = document.getElementById("yearNow");
      yearNow.textContent = new Date().getFullYear();

      // PRÊMIO (2 inputs)
      const premioInput = document.getElementById("premioInput");
      const validadeInput = document.getElementById("validadeInput");
      const prizeSavedAt = document.getElementById("prizeSavedAt");
      const savePrizeBtn = document.getElementById("savePrizeBtn");
      const prizeDocRef = doc(db, "settings", "premioAtual");

      // Coleções
      const cartelasColRef = collection(db, "cartelas");
      const codesColRef = collection(db, "codes");
      const winnersColRef = collection(db, "winners");

      // Estado
      let allCartelas = [];
      let allCodes = [];
      let allWinners = [];
      let deliverCtx = null;
      let appInitialized = false; // evita listeners duplicados

      /* --------- Auth UI --------- */
      function showLogin() {
        adminLoginModal.classList.remove("hidden");
      }
      function hideLogin() {
        adminLoginModal.classList.add("hidden");
      }
      function showPanel() {
        adminMode.classList.remove("hidden");
        logoutBtn.classList.remove("hidden");
        winnersBtn.classList.remove("hidden");
      }
      function hidePanel() {
        adminMode.classList.add("hidden");
        logoutBtn.classList.add("hidden");
        winnersBtn.classList.add("hidden");
      }

      async function handleAdminLogin() {
        const email = adminEmail.value.trim();
        const pass = adminPass.value.trim();
        if (!email || !pass) return alert("Preencha e-mail e senha.");
        try {
          await signInWithEmailAndPassword(auth, email, pass);
        } catch (e) {
          console.error(e);
          alert("❌ Não foi possível entrar. Verifique as credenciais.");
        }
      }
      async function handleLogout() {
        try {
          await signOut(auth);
        } catch (e) {}
        hidePanel();
        adminBadge.classList.add("hidden");
        adminBadge.textContent = "";
        window.location.href = "index.html";
      }
      adminLoginBtn.addEventListener("click", handleAdminLogin);
      adminPass.addEventListener("keydown", (e) => {
        if (e.key === "Enter") handleAdminLogin();
      });
      logoutBtn.addEventListener("click", handleLogout);

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          hideLogin();
          showPanel();
          adminBadge.classList.remove("hidden");
          adminBadge.textContent = `Admin: ${user.email}`;
          await initAppOnce(); // monta tudo já na entrada
        } else {
          hidePanel();
          showLogin();
        }
      });

      /* --------- Helpers --------- */
      const fmtPhone = (p) =>
        (p || "").replace(/(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
      const progressWidth = (stamped, stamps) =>
        Math.round(((stamped?.length || 0) / stamps) * 100);
      const hasOpenWinner = (c) => c.winner && c.winner.delivered === false;

      /* --------- INIT (carrega imediato + listeners) --------- */
      async function initAppOnce() {
        if (appInitialized) return;
        appInitialized = true;

        // 1) Carregamento IMEDIATO
        await Promise.all([
          loadPrizeOnce(),
          loadCodesOnce(),
          loadCartelasOnce(),
          loadWinnersOnce(),
        ]);

        // 2) Listeners em tempo real
        onSnapshot(prizeDocRef, (snap) => {
          if (snap.exists()) {
            const d = snap.data();
            premioInput.value = d.premio || "";
            validadeInput.value = d.validade || "";
            prizeSavedAt.textContent = d.updatedAt?.toDate
              ? `Atualizado em ${d.updatedAt.toDate().toLocaleString("pt-BR")}`
              : "";
          }
        });

        onSnapshot(cartelasColRef, (snap) => {
          allCartelas = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
          renderAdminCartelas(allCartelas);
        });

        onSnapshot(codesColRef, (snap) => {
          allCodes = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
          renderActiveCodes(allCodes);
        });

        onSnapshot(
          query(winnersColRef, orderBy("createdAt", "desc")),
          (snap) => {
            allWinners = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
            renderWinners();
          }
        );
      }

      async function loadPrizeOnce() {
        const s = await getDoc(prizeDocRef);
        if (s.exists()) {
          const d = s.data();
          premioInput.value = d.premio || "";
          validadeInput.value = d.validade || "";
          prizeSavedAt.textContent = d.updatedAt?.toDate
            ? `Atualizado em ${d.updatedAt.toDate().toLocaleString("pt-BR")}`
            : "";
        }
      }
      async function loadCodesOnce() {
        const qs = await getDocs(codesColRef);
        allCodes = qs.docs.map((d) => ({ id: d.id, ...d.data() }));
        renderActiveCodes(allCodes);
      }
      async function loadCartelasOnce() {
        const qs = await getDocs(cartelasColRef);
        allCartelas = qs.docs.map((d) => ({ id: d.id, ...d.data() }));
        renderAdminCartelas(allCartelas);
      }
      async function loadWinnersOnce() {
        const qs = await getDocs(
          query(winnersColRef, orderBy("createdAt", "desc"))
        );
        allWinners = qs.docs.map((d) => ({ id: d.id, ...d.data() }));
        renderWinners();
      }

      /* --------- PRÊMIO --------- */
      savePrizeBtn.addEventListener("click", async () => {
        const premio = (premioInput.value || "").trim();
        const validade = (validadeInput.value || "").trim();
        if (!premio || !validade) {
          alert("Preencha Prêmio e Validade.");
          return;
        }
        try {
          await setDoc(
            prizeDocRef,
            { premio, validade, updatedAt: serverTimestamp() },
            { merge: true }
          );
          alert("✅ Prêmio salvo!");
        } catch (e) {
          console.error(e);
          alert("❌ Não foi possível salvar o prêmio (regras?).");
        }
      });

      /* --------- Render Cartelas --------- */
      function createCartelaHTML(cartela) {
        const stampsButtons = [];
        for (let i = 1; i <= cartela.stamps; i++) {
          const stamped = (cartela.stamped || []).includes(i);
          stampsButtons.push(`
            <div class="stamp-circle ${
              stamped ? "stamped" : ""
            }" onclick="window.toggleStamp('${cartela.id}',${i})">
              ${stamped ? "✓" : i}
            </div>
          `);
        }
        const progress = progressWidth(cartela.stamped || [], cartela.stamps);
        const winnerBlock = hasOpenWinner(cartela)
          ? `
          <div class="mt-4 p-4 bg-emerald-50 border-2 border-amber-300 rounded-lg text-center">
            <div class="text-green-800 font-bold text-lg">🎉 CARTÃO GANHADOR! 🎉</div>
            <div class="text-amber-700 text-sm mt-1">
              Ganhou em: <span class="font-semibold">${
                cartela.winner.at?.toDate
                  ? cartela.winner.at.toDate().toLocaleString("pt-BR")
                  : "—"
              }</span>
            </div>
            <div class="text-gray-700 text-sm mt-1">Aguardando entrega do prêmio.</div>
            <button class="mt-3 btn btn-green" onclick="window.openDeliver('${
              cartela.winner.winnerDocId
            }','${cartela.id}')">Entregar prêmio</button>
          </div>`
          : "";

        return `
          <div class="cartela p-4 sm:p-6 ${
            !cartela.active ? "opacity-60 border-red-300" : ""
          }">
            <div class="text-center mb-4">
              <div class="flex flex-wrap items-center justify-center gap-2 mb-1">
                <div class="text-lg sm:text-xl font-bold text-gray-800">👤 ${
                  cartela.name
                }</div>
                <span class="text-xs px-2 py-1 rounded-full ${
                  cartela.active
                    ? "bg-green-100 text-green-700"
                    : "bg-red-100 text-red-700"
                }">${cartela.active ? "Ativo" : "Inativo"}</span>
              </div>
              <div class="text-base sm:text-lg font-semibold text-blue-600 mb-2">📞 ${fmtPhone(
                cartela.phone
              )}</div>
              <div class="text-sm text-gray-600">Pontos: ${
                (cartela.stamped || []).length
              }/${cartela.stamps} (${progress}%)</div>
              <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                <div class="bg-green-500 h-2 rounded-full" style="width:${progress}%"></div>
              </div>
            </div>
            <div class="grid grid-cols-5 gap-2 sm:gap-3 justify-items-center">${stampsButtons.join(
              ""
            )}</div>
            ${winnerBlock}
            <div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-2">
              <button onclick="window.toggleUserStatus('${
                cartela.id
              }')" class="btn ${cartela.active ? "btn-amber" : "btn-green"}">
                ${cartela.active ? "⏸ Desativar" : "▶ Ativar"}
              </button>
              <button onclick="window.resetCartela('${
                cartela.id
              }')" class="btn btn-amber">🔄 Resetar</button>
              <button onclick="window.editCartela('${
                cartela.id
              }')" class="btn btn-prim">✏ Editar</button>
              <button onclick="window.deleteCartela('${
                cartela.id
              }')" class="btn btn-red">🗑 Excluir</button>
            </div>
          </div>
        `;
      }
      function renderAdminCartelas(cartelas) {
        const term = (searchCards.value || "").toLowerCase().trim();
        const src = term
          ? cartelas.filter(
              (c) =>
                c.name.toLowerCase().includes(term) ||
                (c.phone || "").includes(term)
            )
          : cartelas;
        adminCartelasGrid.innerHTML = src
          .map((c) => createCartelaHTML(c))
          .join("");
      }
      searchCards.addEventListener("input", () =>
        renderAdminCartelas(allCartelas)
      );

      /* --------- Codes UI --------- */
      function renderActiveCodes(codes) {
        if (!codes.length) {
          activeCodesList.innerHTML =
            '<p class="text-gray-500 text-sm">Nenhum código cadastrado</p>';
          return;
        }
        activeCodesList.innerHTML = codes
          .map(
            (code) => `
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-3 bg-white rounded-lg border ${
            code.active ? "border-green-200" : "border-red-200"
          }">
            <div class="flex flex-wrap items-center gap-3">
              <span class="font-mono font-bold text-lg ${
                code.active ? "text-green-700" : "text-red-500"
              }">${code.id}</span>
              <span class="text-sm text-gray-600">1 ponto</span>
              <span class="text-xs px-2 py-1 rounded-full ${
                code.active
                  ? "bg-green-100 text-green-700"
                  : "bg-red-100 text-red-700"
              }">
                ${code.active ? "Ativo" : "Inativo"}
              </span>
            </div>
            <div class="flex flex-wrap gap-2">
              <button onclick="window.toggleCodeStatus('${
                code.id
              }')" class="text-xs px-3 py-1 rounded ${
              code.active ? "btn-amber" : "btn-green"
            }">
                ${code.active ? "Desativar" : "Ativar"}
              </button>
              <button onclick="window.editCode('${
                code.id
              }')" class="text-xs px-3 py-1 rounded btn btn-prim">Editar</button>
              <button onclick="window.deleteCode('${
                code.id
              }')" class="text-xs px-3 py-1 rounded btn btn-red">Excluir</button>
            </div>
          </div>`
          )
          .join("");
      }

      /* --------- Winners modal --------- */
      const openWinners = () => {
        winnersModal.classList.remove("hidden");
        winnersModal.classList.add("flex");
      };
      const closeWinnersM = () => {
        winnersModal.classList.add("hidden");
        winnersModal.classList.remove("flex");
      };
      winnersBtn.addEventListener("click", openWinners);
      openWinnersTop.addEventListener("click", openWinners);
      closeWinners.addEventListener("click", closeWinnersM);
      winnersModal.addEventListener("click", (e) => {
        if (e.target === winnersModal) closeWinnersM();
      });

      function renderWinners() {
        winnersLoading?.remove();
        if (!allWinners.length) {
          winnersTable.innerHTML = `<tr><td colspan="5" class="px-3 py-6 text-center text-gray-500">Sem ganhadores ainda</td></tr>`;
          return;
        }
        winnersTable.innerHTML = allWinners
          .map(
            (w) => `
          <tr class="border-b last:border-0">
            <td class="px-3 py-2">${w.name}</td>
            <td class="px-3 py-2">${fmtPhone(w.phone)}</td>
            <td class="px-3 py-2">${
              w.createdAt?.toDate
                ? w.createdAt.toDate().toLocaleString("pt-BR")
                : "—"
            }</td>
            <td class="px-3 py-2">
              ${
                w.delivered
                  ? '<span class="text-green-700 bg-green-100 px-2 py-1 rounded text-xs">Entregue</span>'
                  : '<span class="text-amber-700 bg-amber-100 px-2 py-1 rounded text-xs">Pendente</span>'
              }
            </td>
            <td class="px-3 py-2">
              ${
                w.delivered
                  ? ""
                  : `<button onclick="window.openDeliver('${w.id}','${w.cartelaId}')" class="px-3 py-1 rounded btn btn-green text-xs">Entregar prêmio</button>`
              }
            </td>
          </tr>`
          )
          .join("");
      }

      /* --------- Cartelas: ações --------- */
      document
        .getElementById("addCartelaBtn")
        .addEventListener("click", addNewCartela);
      document
        .getElementById("blockAllCardsBtn")
        .addEventListener("click", blockAllCards);
      document
        .getElementById("deleteAllCardsBtn")
        .addEventListener("click", deleteAllCards);

      async function addNewCartela() {
        const name = document.getElementById("newName").value.trim();
        const phone = document.getElementById("newPhone").value.trim();
        const stamps = parseInt(document.getElementById("newStamps").value, 10);
        if (!name || !phone) return alert("❌ Preencha todos os campos!");
        if (phone.length < 10 || phone.length > 11)
          return alert("❌ Telefone deve ter 10 ou 11 dígitos!");
        await addDoc(cartelasColRef, {
          name,
          phone,
          stamps,
          stamped: [],
          active: true,
          createdAt: serverTimestamp(),
        });
        document.getElementById("newName").value = "";
        document.getElementById("newPhone").value = "";
        alert("✅ Cartão criado!");
      }

      const stampingLock = new Set();
      async function toggleStamp(cartelaId, num) {
        const lockKey = `${cartelaId}:${num}`;
        if (stampingLock.has(lockKey)) return;
        stampingLock.add(lockKey);
        try {
          const c = allCartelas.find((x) => x.id === cartelaId);
          if (!c || hasOpenWinner(c)) return;
          const newStamped = (c.stamped || []).includes(num)
            ? (c.stamped || []).filter((n) => n !== num)
            : [...(c.stamped || []), num].sort((a, b) => a - b);
          await updateDoc(doc(db, "cartelas", cartelaId), {
            stamped: newStamped,
          });
        } catch (e) {
          console.error(e);
          alert("❌ Não foi possível marcar. Tente novamente.");
        } finally {
          stampingLock.delete(lockKey);
        }
      }

      async function resetCartela(cartelaId) {
        if (!confirm("Resetar este cartão?")) return;
        await updateDoc(doc(db, "cartelas", cartelaId), { stamped: [] });
        const usedRef = collection(db, "cartelas", cartelaId, "usedCodes");
        const usedSnap = await getDocs(usedRef);
        const batch = writeBatch(db);
        usedSnap.forEach((d) =>
          batch.delete(doc(db, "cartelas", cartelaId, "usedCodes", d.id))
        );
        await batch.commit();
        alert("✅ Cartão resetado!");
      }

      async function deleteCartela(cartelaId) {
        if (!confirm("Excluir este cartão permanentemente?")) return;
        const usedRef = collection(db, "cartelas", cartelaId, "usedCodes");
        const usedSnap = await getDocs(usedRef);
        const batch = writeBatch(db);
        usedSnap.forEach((d) =>
          batch.delete(doc(db, "cartelas", cartelaId, "usedCodes", d.id))
        );
        batch.delete(doc(db, "cartelas", cartelaId));
        await batch.commit();
        alert("🗑 Cartão excluído!");
      }

      async function toggleUserStatus(cartelaId) {
        const c = allCartelas.find((x) => x.id === cartelaId);
        if (!c) return;
        const action = c.active ? "desativar" : "ativar";
        if (!confirm(`Deseja ${action} o cartão de ${c.name}?`)) return;
        await updateDoc(doc(db, "cartelas", cartelaId), { active: !c.active });
      }

      async function editCartela(cartelaId) {
        const c = allCartelas.find((x) => x.id === cartelaId);
        if (!c) return;
        const newName = prompt(`Editar nome (atual: ${c.name})`, c.name);
        if (newName === null) return;
        const newPhone = prompt(`Editar telefone (atual: ${c.phone})`, c.phone);
        if (newPhone === null) return;
        if (newPhone.length < 10 || newPhone.length > 11)
          return alert("Telefone inválido");
        await updateDoc(doc(db, "cartelas", cartelaId), {
          name: newName.trim(),
          phone: newPhone.trim(),
        });
        alert("✅ Cartão atualizado!");
      }

      async function blockAllCards() {
        if (!confirm("Bloquear todos os cartões?")) return;
        const batch = writeBatch(db);
        allCartelas.forEach((c) =>
          batch.update(doc(db, "cartelas", c.id), { active: false })
        );
        await batch.commit();
        alert("🔒 Todos bloqueados.");
      }

      async function deleteAllCards() {
        if (!confirm("IRREVERSÍVEL! Excluir TODOS os cartões?")) return;
        const k = prompt('Digite "CONFIRMAR" para prosseguir:');
        if (k !== "CONFIRMAR") return alert("Cancelado.");
        for (const c of allCartelas) {
          const usedRef = collection(db, "cartelas", c.id, "usedCodes");
          const usedSnap = await getDocs(usedRef);
          const batch = writeBatch(db);
          usedSnap.forEach((d) =>
            batch.delete(doc(db, "cartelas", c.id, "usedCodes", d.id))
          );
          batch.delete(doc(db, "cartelas", c.id));
          await batch.commit();
        }
        alert("🗑 Todos os cartões excluídos.");
      }

      /* --------- Códigos (CRUD) --------- */
      document
        .getElementById("addCodeBtn")
        .addEventListener("click", addNewCode);
      async function addNewCode() {
        const raw = document.getElementById("newCode").value.trim();
        const code = raw.toUpperCase();
        if (!code) return alert("Digite um código");
        try {
          const ref = doc(db, "codes", code);
          const snap = await getDoc(ref);
          if (snap.exists())
            return alert("⚠ Já existe um código com esse nome.");
          await setDoc(ref, {
            points: 1,
            active: true,
            createdAt: serverTimestamp(),
          });
          document.getElementById("newCode").value = "";
          alert("✅ Código criado!");
        } catch (e) {
          console.error(e);
          alert("❌ Erro ao criar código (regras?).");
        }
      }
      async function toggleCodeStatus(codeId) {
        try {
          const ref = doc(db, "codes", codeId);
          const snap = await getDoc(ref);
          if (!snap.exists()) return;
          await updateDoc(ref, { active: !snap.data().active });
        } catch (e) {
          console.error(e);
          alert("❌ Erro ao mudar status do código.");
        }
      }
      async function editCode(oldCode) {
        const n = prompt(`Editar código "${oldCode}"`, oldCode);
        if (n === null) return;
        const up = n.trim().toUpperCase();
        if (!up || up === oldCode) return;
        try {
          const newRef = doc(db, "codes", up);
          if ((await getDoc(newRef)).exists())
            return alert("⚠ Já existe um código com esse nome!");
          const oldRef = doc(db, "codes", oldCode);
          const snap = await getDoc(oldRef);
          if (!snap.exists()) return;
          await setDoc(newRef, snap.data());
          await deleteDoc(oldRef);
          alert(`✅ Código alterado para "${up}".`);
        } catch (e) {
          console.error(e);
          alert("❌ Erro ao renomear código.");
        }
      }
      async function deleteCode(codeId) {
        if (!confirm(`Excluir código ${codeId}?`)) return;
        try {
          await deleteDoc(doc(db, "codes", codeId));
          alert("✅ Código excluído.");
        } catch (e) {
          console.error(e);
          alert("❌ Erro ao excluir código.");
        }
      }

      /* --------- Winner flow --------- */
      function openDeliver(winnerId, cartelaId) {
        deliverCtx = { winnerId, cartelaId };
        deliverDate.value = new Date().toISOString().slice(0, 16);
        deliverModal.classList.remove("hidden");
        deliverModal.classList.add("flex");
      }
      function closeDeliver() {
        deliverModal.classList.add("hidden");
        deliverModal.classList.remove("flex");
        deliverCtx = null;
      }
      document
        .getElementById("deliverCancel")
        .addEventListener("click", closeDeliver);
      document
        .getElementById("deliverConfirm")
        .addEventListener("click", async () => {
          if (!deliverCtx) return;
          try {
            const when = new Date(deliverDate.value);
            await updateDoc(doc(db, "winners", deliverCtx.winnerId), {
              delivered: true,
              deliveredAt: when,
            });
            const cRef = doc(db, "cartelas", deliverCtx.cartelaId);
            const cSnap = await getDoc(cRef);
            if (cSnap.exists()) {
              const w = cSnap.data().winner || {};
              await updateDoc(cRef, {
                winner: { ...w, delivered: true, deliveredAt: when },
              });
            }
            // Reset geral
            const batchSize = 400;
            for (let i = 0; i < allCartelas.length; i += batchSize) {
              const slice = allCartelas.slice(i, i + batchSize);
              const batch = writeBatch(db);
              slice.forEach((c) =>
                batch.update(doc(db, "cartelas", c.id), { stamped: [] })
              );
              await batch.commit();
            }
            for (const c of allCartelas) {
              const usedRef = collection(db, "cartelas", c.id, "usedCodes");
              const usedSnap = await getDocs(usedRef);
              const batch = writeBatch(db);
              usedSnap.forEach((d) =>
                batch.delete(doc(db, "cartelas", c.id, "usedCodes", d.id))
              );
              await batch.commit();
            }
            alert("✅ Entrega confirmada e nova rodada iniciada!");
            closeDeliver();
          } catch (e) {
            console.error(e);
            alert("❌ Falha ao confirmar entrega (regras?).");
          }
        });

      // Expose (para onclick inline)
      window.toggleStamp = toggleStamp;
      window.resetCartela = resetCartela;
      window.deleteCartela = deleteCartela;
      window.toggleUserStatus = toggleUserStatus;
      window.editCartela = editCartela;
      window.toggleCodeStatus = toggleCodeStatus;
      window.editCode = editCode;
      window.deleteCode = deleteCode;
      window.openDeliver = openDeliver;

      // Privacy modal
      openPrivacy.addEventListener("click", () => {
        privacyModal.classList.remove("hidden");
        privacyModal.classList.add("flex");
      });
      closePrivacy.addEventListener("click", () => {
        privacyModal.classList.add("hidden");
        privacyModal.classList.remove("flex");
      });
      privacyModal.addEventListener("click", (e) => {
        if (e.target === privacyModal) {
          privacyModal.classList.add("hidden");
          privacyModal.classList.remove("flex");
        }
      });

      // Start
      showLogin();
    </script>

    <!-- DICA DE RULES:
      rules_version = '2';
      service cloud.firestore {
        match /databases/{database}/documents {
          function isAdmin() {
            return request.auth != null && (
              request.auth.token.email == 'SEU-EMAIL@DOMINIO.COM'
            );
          }
          match /codes/{id} { allow read: if true; allow write: if isAdmin(); }
          match /settings/{doc} { allow read: if true; allow write: if isAdmin(); }
          match /cartelas/{id} { allow read: if true; allow write: if isAdmin(); }
          match /cartelas/{id}/usedCodes/{code} { allow read: if true; allow write: if isAdmin(); }
          match /winners/{id} { allow read: if true; allow write: if isAdmin(); }
        }
      }
    -->
  </body>
</html>
